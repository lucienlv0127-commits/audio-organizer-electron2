<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<title>音频搜索</title>
<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline'">
<style>
  :root { --pad:12px; --row-border:#eee; }
  *{box-sizing:border-box}
  body{font-family:-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#fff}
  header{position:sticky;top:0;z-index:10;display:flex;gap:8px;align-items:center;padding:10px var(--pad);border-bottom:1px solid #ddd;background:#fff}
  #folder{color:#666;font-size:12px}
  main{padding:8px var(--pad) 96px} /* 给底部悬浮播放器留出空间 */
  table{border-collapse:collapse;width:100%}
  th,td{border-bottom:1px solid var(--row-border);padding:8px;text-align:left;vertical-align:top}
  th{background:#fafafa;position:sticky;top:52px;z-index:5}
  .btn{padding:6px 10px;border:1px solid #ccc;border-radius:6px;background:#fafafa;cursor:pointer}
  .grow{flex:1}
  .taginput{width:220px}

  /* 悬浮播放器：固定在窗口最下方 */
  .player-bar{
    position:fixed;left:0;right:0;bottom:0;z-index:9999;
    display:flex;gap:10px;align-items:center;
    padding:10px var(--pad);border-top:1px solid #ddd;
    background:rgba(250,250,250,.9);backdrop-filter:saturate(1.2) blur(6px);
  }
  #seek{flex:1;appearance:none;height:6px;border-radius:3px;background:#ddd;outline:none}
  #seek::-webkit-slider-thumb{appearance:none;width:14px;height:14px;border-radius:50%;background:#555;border:0;margin-top:-4px}
  #nowPlaying{color:#666;font-size:12px;text-align:right}
</style>
</head>
<body>
<header>
  <button class="btn" id="btnPick">选择文件夹</button>
  <button class="btn" id="btnRescan">重新扫描</button>
  <select id="catFilter">
    <option value="">全部分类</option>
    <option value="SFX">音效 (SFX)</option>
    <option value="Music">配乐 (Music)</option>
    <option value="Uncategorized">未分类</option>
  </select>
  <input id="search" placeholder="搜索 文件名/标签/分类…" class="grow"/>
  <span id="folder"></span>
</header>

<main><table id="list"></table></main>

<!-- 悬浮播放器（窗口最下方） -->
<div class="player-bar" id="bar">
  <button id="pp" class="btn" style="min-width:48px">▶</button>
  <span id="cur" style="width:56px;text-align:right">00:00</span>
  <input id="seek" type="range" min="0" max="0" value="0" step="0.01">
  <span id="dur" style="width:56px">00:00</span>
  <span id="nowPlaying" class="grow"></span>
  <audio id="player" preload="metadata" style="display:none"></audio>
</div>

<script>
  // --- 基本引用 ---
  const bridge = window.api;

  // --- 状态 ---
  let folderPath = null;
  let items = [];
  let filterText = '';
  let filterCat  = '';

  // --- DOM ---
  const listEl   = document.getElementById('list');
  const folderEl = document.getElementById('folder');
  const player   = document.getElementById('player');
  const ppBtn    = document.getElementById('pp');
  const seek     = document.getElementById('seek');
  const curEl    = document.getElementById('cur');
  const durEl    = document.getElementById('dur');
  const nowEl    = document.getElementById('nowPlaying');

  // --- 工具 ---
  const fmt = s => { s = Math.max(0, Math.floor(s||0)); return String((s/60)|0).padStart(2,'0')+':'+String(s%60).padStart(2,'0'); };
  const base = p => String(p||'').split(/[\\/]/).pop();

  function applyFilter(arr){
    const kw = filterText.trim().toLowerCase();
    return arr.filter(it => {
      if (base(it.url||it.path).startsWith('._')) return false; // 过滤 AppleDouble
      if (filterCat && it.category !== filterCat) return false;
      if (!kw) return true;
      const hay = [it.fileName, ...(it.tags||[]), it.category].join(' ').toLowerCase();
      return hay.includes(kw);
    });
  }

  function render(){
    const data = applyFilter(items);
    const head = '<tr><th style="width:70px">试听</th><th>文件名</th><th style="width:90px">时长</th><th style="width:220px">分类</th><th style="width:300px">标签</th><th style="width:220px">操作</th></tr>';
    const rows = data.map(it=>{
      const p  = it.url || it.path;
      const esc= String(p).replace(/&/g,'&amp;').replace(/</g,'&lt;');
      const name = it.fileName || base(p) || '(未知文件)';
      return `
        <tr data-key="${p}">
          <td><button class="btn play" data-play="${p}">▶</button></td>
          <td><div>${name}</div><div style="font-size:12px;color:#777">${esc}</div></td>
          <td class="dur-cell">${fmt(it.durationSeconds)}</td>
          <td>
            <select class="cat">
              <option value="SFX" ${it.category==='SFX'?'selected':''}>音效 (SFX)</option>
              <option value="Music" ${it.category==='Music'?'selected':''}>配乐 (Music)</option>
              <option value="Uncategorized" ${(!it.category||it.category==='Uncategorized')?'selected':''}>未分类</option>
            </select>
          </td>
          <td>
            <input class="tags taginput" type="text" value="${Array.isArray(it.tags)? it.tags.join(', '):(it.tags||'')}"/>
            <button class="btn saveTags">保存</button>
          </td>
          <td>
            <button class="btn open" data-open="${p}">打开文件</button>
            <button class="btn reveal" data-reveal="${p}">显示所在位置</button>
          </td>
        </tr>`;
    }).join('');
    listEl.innerHTML = head + rows;
  }

  // --- 播放器逻辑（可拖动） ---
  let userDragging = false;

  player.addEventListener('loadedmetadata', () => {
    const d = isFinite(player.duration) ? player.duration : 0;
    seek.max = d; durEl.textContent = fmt(d);
    // 若切到新歌，重置进度显示
    curEl.textContent = '00:00'; seek.value = 0;
  });

  player.addEventListener('timeupdate', () => {
    if (userDragging) return; // 用户正在拖动时，不要 UI 反向覆盖
    if (!isNaN(player.currentTime)) {
      seek.value = player.currentTime;
      curEl.textContent = fmt(player.currentTime);
    }
  });

  player.addEventListener('ended', () => { ppBtn.textContent = '▶'; });

  // 拖动开始/过程中实时跳转
  seek.addEventListener('pointerdown', () => { userDragging = true; });
  seek.addEventListener('input', () => {
    const t = Number(seek.value||0);
    curEl.textContent = fmt(t);
    if (isFinite(player.duration) && player.duration > 0) {
      player.currentTime = t; // 实时跟随拖动
    }
  });
  // 拖动结束
  const endDrag = () => { userDragging = false; };
  seek.addEventListener('pointerup', endDrag);
  seek.addEventListener('pointercancel', endDrag);
  seek.addEventListener('change', endDrag);

  // 播放/暂停
  ppBtn.onclick = async () => {
    if (!player.src) return;
    if (player.paused) { await player.play(); ppBtn.textContent = '⏸'; }
    else { player.pause(); ppBtn.textContent = '▶'; }
  };

  // --- 异步补齐时长（并持久化） ---
  async function fillDurations(list, { concurrency=4 } = {}) {
    const queue = list.filter(it => !it.durationSeconds || it.durationSeconds<=0);
    if (!queue.length) return;
    let i = 0;
    async function worker(){
      const tmp = new Audio(); tmp.preload = 'metadata';
      while (i < queue.length) {
        const it = queue[i++];
        try {
          const url = bridge.toFileUrl(it.url || it.path);
          await new Promise((res) => {
            const done=()=>{cleanup();res();};
            const fail=()=>{cleanup();res();}; // 忽略个别失败
            const cleanup=()=>{tmp.removeEventListener('loadedmetadata',done);tmp.removeEventListener('error',fail);};
            tmp.addEventListener('loadedmetadata', done);
            tmp.addEventListener('error', fail);
            tmp.src = url; tmp.load();
          });
          if (isFinite(tmp.duration) && tmp.duration>0) {
            it.durationSeconds = Math.round(tmp.duration);
            // 局部刷新该行
            const row = document.querySelector(`tr[data-key="${it.url||it.path}"] .dur-cell`);
            if (row) row.textContent = fmt(it.durationSeconds);
          }
        } catch(_) {}
      }
    }
    await Promise.all(Array.from({length:Math.min(concurrency, queue.length)}, worker));
    await bridge.saveState({ folderPath, items });
  }

  // --- 顶部操作 ---
  async function pick(){
    const p = await bridge.pickFolder(); if (!p) return;
    folderPath = p; folderEl.textContent = p;
    await rescan();
  }

  async function rescan(){
    if (!folderPath) return;
    const map = await bridge.scanFolder(folderPath);
    const arr = Object.values(map).map(n=>{
      const old = items.find(x => (x.url||x.path)===n.url);
      return {...n, category: old?.category||'Uncategorized', tags: old?.tags||[]};
    }).sort((a,b)=> a.fileName.localeCompare(b.fileName,'zh-Hans-CN'));
    items = arr;
    await bridge.saveState({folderPath,items});
    render();
    fillDurations(items);
  }

  // --- 列表事件 ---
  listEl.addEventListener('click', async (e)=>{
    const t = e.target;
    if (!(t instanceof HTMLElement)) return;
    const tr = t.closest('tr'); if (!tr) return;
    const key= tr.getAttribute('data-key');
    const it = items.find(x => (x.url||x.path)===key);
    if (!it) return;

    if (t.classList.contains('play')) {
      const p = it.url || it.path;
      try {
        const url = bridge.toFileUrl(p);
        if (player.src !== url) {
          player.src = url;
          // 等到元数据后，进度条才可拖
          await new Promise((res,rej)=>{
            const ok = ()=>{ player.removeEventListener('loadedmetadata', ok); res(); };
            const er = (e)=>{ player.removeEventListener('error', er); rej(e); };
            player.addEventListener('loadedmetadata', ok, {once:true});
            player.addEventListener('error', er, {once:true});
            player.load();
          });
        }
        await player.play();
        ppBtn.textContent = '⏸';
        nowEl.textContent = base(p);
      } catch(err) {
        console.error('play failed', err);
        alert('无法播放：\n' + (it.url||it.path));
      }
    } else if (t.classList.contains('open')) {
      bridge.openFile(it.url||it.path);
    } else if (t.classList.contains('reveal')) {
      bridge.revealFile(it.url||it.path);
    } else if (t.classList.contains('saveTags')) {
      const input = tr.querySelector('.tags');
      it.tags = (input.value||'').split(',').map(s=>s.trim()).filter(Boolean);
      await bridge.saveState({folderPath,items});
      render();
    }
  });

  listEl.addEventListener('change', async (e)=>{
    const t = e.target;
    if (!(t instanceof HTMLElement)) return;
    if (!t.classList.contains('cat')) return;
    const tr = t.closest('tr'); if (!tr) return;
    const key= tr.getAttribute('data-key');
    const it = items.find(x => (x.url||x.path)===key);
    if (!it) return;
    it.category = t.value || 'Uncategorized';
    await bridge.saveState({folderPath,items});
  });

  // --- 顶部控件绑定 ---
  document.getElementById('btnPick').onclick   = pick;
  document.getElementById('btnRescan').onclick = rescan;
  document.getElementById('catFilter').onchange= (e)=>{ filterCat=e.target.value; render(); };
  document.getElementById('search').oninput    = (e)=>{ filterText=e.target.value; render(); };

  // --- 启动恢复 ---
  (async()=>{
    const st = await bridge.loadState();
    if (st) {
      folderPath = st.folderPath || null;
      items = (st.items || []).map(it=>({
        ...it,
        url: it?.url || it?.path || it?.full || it?.fullPath || it?.file || '',
        category: it?.category || 'Uncategorized',
        tags: Array.isArray(it?.tags)? it.tags : [],
      })).filter(it => it.url && !base(it.url).startsWith('._'));
      if (folderPath) folderEl.textContent = folderPath;
    }
    render();
    fillDurations(items);
  })();
</script>
</body>
</html>
